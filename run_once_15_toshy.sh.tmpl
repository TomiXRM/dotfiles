{{- if eq .chezmoi.os "linux" -}}
#!/usr/bin/env bash
set -euo pipefail

echo "=== [run_once_15_toshy] Started at $(date) ==="

if [ ! -r /etc/os-release ]; then
  echo "os-release not found; skipping toshy install."
  exit 0
fi

. /etc/os-release
if [ "${ID:-}" != "ubuntu" ]; then
  echo "Not Ubuntu (ID=${ID:-unknown}); skipping toshy install."
  exit 0
fi

if ! command -v git >/dev/null 2>&1; then
  echo "git not found; install it and re-run."
  exit 0
fi

if ! command -v python3 >/dev/null 2>&1; then
  echo "python3 not found; install it and re-run."
  exit 0
fi

TOSHY_DIR="$(mktemp -d -t toshy-XXXXXXXX)"
cleanup() {
  rm -rf "$TOSHY_DIR"
}
trap cleanup EXIT
echo "Cloning toshy..."
git clone https://github.com/RedBearAK/toshy.git "$TOSHY_DIR"

echo "Installing toshy..."
python3 "$TOSHY_DIR/setup_toshy.py" install

echo "toshy_config.py is managed by chezmoi directly."
{{- end -}}
