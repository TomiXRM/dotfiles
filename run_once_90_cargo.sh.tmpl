{{- if eq .chezmoi.os "linux" -}}
#!/usr/bin/env bash
set -euo pipefail

echo "=== [run_once_90_cargo] Started at $(date) ==="

if [ ! -r /etc/os-release ]; then
  echo "os-release not found; skipping cargo install."
  exit 0
fi

. /etc/os-release
if [ "${ID:-}" != "ubuntu" ]; then
  echo "Not Ubuntu (ID=${ID:-unknown}); skipping cargo install."
  exit 0
fi

if ! command -v cargo >/dev/null 2>&1; then
  echo "cargo not found; Rust should be installed via mise in run_once_80_mise_install.sh."
  exit 0
fi

# Activate mise to ensure cargo shims are available
if command -v mise >/dev/null 2>&1; then
  eval "$(mise activate bash --shims)" || true
  export PATH="$HOME/.local/share/mise/shims:$PATH"
fi

PACKAGES_FILE="{{ .chezmoi.sourceDir }}/packages/cargo.txt"
if [ ! -f "$PACKAGES_FILE" ]; then
  echo "Missing packages/cargo.txt; nothing to install."
  exit 0
fi

mapfile -t packages < <(grep -v -E '^[[:space:]]*#|^[[:space:]]*$' "$PACKAGES_FILE" || true)
if [ "${#packages[@]}" -eq 0 ]; then
  echo "packages/cargo.txt is empty; nothing to install."
  exit 0
fi

echo "Installing cargo packages (${#packages[@]}): ${packages[*]}"
for pkg in "${packages[@]}"; do
  cargo install "$pkg"
done
{{- end -}}
