{{- if eq .chezmoi.os "linux" -}}
#!/usr/bin/env bash
set -euo pipefail

echo "=== [run_once_10_os_base] Started at $(date) ==="

if [ ! -r /etc/os-release ]; then
  echo "os-release not found; skipping apt base install."
  exit 0
fi

. /etc/os-release
if [ "${ID:-}" != "ubuntu" ]; then
  echo "Not Ubuntu (ID=${ID:-unknown}); skipping apt base install."
  exit 0
fi

if ! command -v apt-get >/dev/null 2>&1; then
  echo "apt-get not found; skipping apt base install."
  exit 0
fi

PACKAGES_FILE="{{ .chezmoi.sourceDir }}/packages/apt.txt"
if [ ! -f "$PACKAGES_FILE" ]; then
  echo "Missing packages/apt.txt; nothing to install."
  exit 0
fi

mapfile -t packages < <(grep -v -E '^[[:space:]]*#|^[[:space:]]*$' "$PACKAGES_FILE" || true)
if [ "${#packages[@]}" -eq 0 ]; then
  echo "packages/apt.txt is empty; nothing to install."
  exit 0
fi

echo "Installing apt packages (${#packages[@]}): ${packages[*]}"
sudo apt-get update
sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends "${packages[@]}"
{{- end -}}
